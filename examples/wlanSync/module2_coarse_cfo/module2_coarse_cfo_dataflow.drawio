<mxfile host="app.diagrams.net" type="device">
  <diagram name="M2 DATAFLOW Decomposition" id="m2-dataflow">
    <mxGraphModel dx="1400" dy="600" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="1600" pageHeight="1200">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;module2_coarse_cfo - DATAFLOW Decomposition&lt;/b&gt;&lt;br&gt;#pragma HLS DATAFLOW - 3-Stage Pipeline: EXTRACT -&gt; COMPUTE -&gt; APPLY" style="text;html=1;align=left;verticalAlign=top;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- External I/O Ports -->
        <mxCell id="io-data-in" value="&lt;b&gt;data_in&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;26105 samples" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="180" width="100" height="70" as="geometry" />
        </mxCell>

        <mxCell id="io-ctrl-in" value="&lt;b&gt;startOffset_in&lt;/b&gt;&lt;br&gt;index_t (async)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fce7f3;strokeColor=#db2777;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="90" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="io-data-out" value="&lt;b&gt;search_buffer_out&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;640 samples" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1200" y="270" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="io-freq-out" value="&lt;b&gt;coarseFreqOff_out&lt;/b&gt;&lt;br&gt;freq_t" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fce7f3;strokeColor=#db2777;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1200" y="90" width="120" height="60" as="geometry" />
        </mxCell>

        <!-- Stage 1: EXTRACT -->
        <mxCell id="stage-extract-border" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="150" y="70" width="300" height="400" as="geometry" />
        </mxCell>
        <mxCell id="stage-extract-label" value="&lt;b&gt;EXTRACT&lt;/b&gt;&lt;br&gt;extract_with_offset()&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="230" y="75" width="140" height="40" as="geometry" />
        </mxCell>

        <mxCell id="extract-fsm" value="&lt;b&gt;FSM Controller&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;'&gt;WAIT_CTRL: poll startOffset&lt;br&gt;WAIT_DATA_READY: fill buf&lt;br&gt;EXTRACT_STATE: replay&lt;br&gt;DONE: consume remaining&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=10;arcSize=8;verticalAlign=top;spacingTop=3;" vertex="1" parent="1">
          <mxGeometry x="170" y="130" width="160" height="110" as="geometry" />
        </mxCell>

        <mxCell id="extract-circbuf" value="&lt;b&gt;circ_buf[2048]&lt;/b&gt;&lt;br&gt;complex_t BRAM&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;BUF_MASK=2047&lt;br&gt;write_idx &amp;amp; mask&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="350" y="130" width="80" height="100" as="geometry" />
        </mxCell>

        <!-- Stage 2: COMPUTE -->
        <mxCell id="stage-compute-border" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="530" y="70" width="280" height="240" as="geometry" />
        </mxCell>
        <mxCell id="stage-compute-label" value="&lt;b&gt;COMPUTE&lt;/b&gt;&lt;br&gt;compute_cfo()&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="620" y="75" width="100" height="40" as="geometry" />
        </mxCell>

        <mxCell id="compute-autocorr" value="&lt;b&gt;Autocorrelation&lt;/b&gt;&lt;br&gt;160 L-STF samples&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;16-tap shift register&lt;br&gt;complex conj multiply&lt;br&gt;sliding window sum&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="550" y="130" width="140" height="80" as="geometry" />
        </mxCell>

        <mxCell id="compute-cordic" value="&lt;b&gt;CORDIC atan2&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;CFO angle -&gt; freq_t&lt;br&gt;scaling to rad/sample&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=10;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="570" y="230" width="130" height="60" as="geometry" />
        </mxCell>

        <!-- Stage 3: APPLY -->
        <mxCell id="stage-apply-border" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="890" y="70" width="280" height="400" as="geometry" />
        </mxCell>
        <mxCell id="stage-apply-label" value="&lt;b&gt;APPLY&lt;/b&gt;&lt;br&gt;apply_correction()&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="980" y="75" width="120" height="40" as="geometry" />
        </mxCell>

        <mxCell id="apply-nco" value="&lt;b&gt;NCO LUT&lt;/b&gt;&lt;br&gt;sin/cos[1024]&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;quarter-wave ROM_2P&lt;br&gt;linear interpolation&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="920" y="130" width="130" height="70" as="geometry" />
        </mxCell>

        <mxCell id="apply-phase-acc" value="&lt;b&gt;Phase Accum&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;phi += delta_phase&lt;br&gt;per-sample increment&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#99e9f2;strokeColor=#0c8599;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="920" y="220" width="120" height="55" as="geometry" />
        </mxCell>

        <mxCell id="apply-cmul" value="&lt;b&gt;Complex MUL&lt;/b&gt;&lt;br&gt;data * exp(-j*phi)&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;4 DSP48 (I/Q rotation)&lt;br&gt;640 samples&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="920" y="310" width="140" height="70" as="geometry" />
        </mxCell>

        <!-- Inter-stage FIFO arrows -->
        <mxCell id="edge-datain-fsm" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="io-data-in" target="extract-fsm" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-ctrl-fsm" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;html=1;" edge="1" source="io-ctrl-in" target="extract-fsm" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-fsm-buf" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;endArrow=block;endFill=1;html=1;" edge="1" source="extract-fsm" target="extract-circbuf" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FIFO: lstf_stream -->
        <mxCell id="fifo-lstf" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="extract-circbuf" target="compute-autocorr" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="480" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fifo-lstf-label" value="&lt;b&gt;lstf_stream&lt;/b&gt;&lt;br&gt;160 samples&lt;br&gt;depth=160" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#eff6ff;strokeColor=#1971c2;fontSize=9;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="460" y="130" width="80" height="45" as="geometry" />
        </mxCell>

        <!-- FIFO: passthrough_stream (EXTRACT -> APPLY bypass) -->
        <mxCell id="fifo-passthrough" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="extract-circbuf" target="apply-cmul" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="390" y="430" />
              <mxPoint x="990" y="430" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fifo-passthrough-label" value="&lt;b&gt;passthrough_stream&lt;/b&gt;&lt;br&gt;640 samples, depth=680" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#eff6ff;strokeColor=#1971c2;fontSize=9;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="570" y="435" width="160" height="30" as="geometry" />
        </mxCell>

        <!-- Autocorr to CORDIC -->
        <mxCell id="edge-autocorr-cordic" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="compute-autocorr" target="compute-cordic" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FIFO: cfo_stream (COMPUTE -> APPLY) -->
        <mxCell id="fifo-cfo" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;html=1;" edge="1" source="compute-cordic" target="apply-phase-acc" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="850" y="260" />
              <mxPoint x="850" y="247" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fifo-cfo-label" value="&lt;b&gt;cfo_stream&lt;/b&gt;&lt;br&gt;freq_t, depth=4" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#eff6ff;strokeColor=#1971c2;fontSize=9;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="820" y="220" width="70" height="35" as="geometry" />
        </mxCell>

        <!-- NCO to phase acc -->
        <mxCell id="edge-nco-phaseacc" value="sin/cos" style="endArrow=block;endFill=1;html=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;fontSize=9;fontColor=#4f46e5;labelBackgroundColor=#FFFFFF;edgeStyle=orthogonalEdgeStyle;rounded=1;" edge="1" source="apply-nco" target="apply-phase-acc" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Phase acc to cmul -->
        <mxCell id="edge-phaseacc-cmul" value="exp(-j*phi)" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="apply-phase-acc" target="apply-cmul" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- APPLY to outputs -->
        <mxCell id="edge-cmul-dataout" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="apply-cmul" target="io-data-out" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-cordic-freqout" value="coarseFreqOff" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="compute-cordic" target="io-freq-out" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="635" y="320" />
              <mxPoint x="830" y="320" />
              <mxPoint x="830" y="60" />
              <mxPoint x="1260" y="60" />
            </Array>
          </mxGeometry>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
