<mxfile host="app.diagrams.net" type="device">
  <diagram name="M1 Micro-Architecture" id="m1-microarch">
    <mxGraphModel dx="1400" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="1600" pageHeight="1200">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;module1_packet_detect - RTL Micro-Architecture&lt;/b&gt;&lt;br&gt;Case B: Single MAIN_LOOP (N+2), II=1, MATOPT8 Aux Buffers, Deferred Metric Pipeline" style="text;html=1;align=left;verticalAlign=top;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="700" height="40" as="geometry" />
        </mxCell>

        <!-- Input Port -->
        <mxCell id="io-data-in" value="&lt;b&gt;data_in&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;16b I+Q" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="170" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Pipeline Register: Input -->
        <mxCell id="preg-in" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;" vertex="1" parent="1">
          <mxGeometry x="140" y="160" width="8" height="80" as="geometry" />
        </mxCell>

        <!-- data_buf circular BRAM -->
        <mxCell id="mem-data-buf" value="&lt;b&gt;data_buf[32]&lt;/b&gt;&lt;br&gt;circular BRAM&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;D-sample delay&lt;br&gt;ram_s2p, no PARTITION&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="170" y="80" width="140" height="70" as="geometry" />
        </mxCell>

        <!-- Aux product buffers -->
        <mxCell id="mem-aux" value="&lt;b&gt;C_re/C_im/P [16]&lt;/b&gt;&lt;br&gt;3x circular BRAM&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;MATOPT8 cached products&lt;br&gt;0-DSP subtract-old&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="170" y="260" width="140" height="80" as="geometry" />
        </mxCell>

        <!-- Window Update / Correlation compute -->
        <mxCell id="hw-window" value="&lt;b&gt;WINDOW UPDATE&lt;/b&gt;&lt;br&gt;conj(x[n]) * x[n-D]&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;new products: 8 MUL&lt;br&gt;old products: read from aux&lt;br&gt;delta = new - old&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="155" width="160" height="90" as="geometry" />
        </mxCell>

        <!-- DSP annotation for window -->
        <mxCell id="dsp-window" value="&lt;b&gt;DSP: 8 MUL&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;complex conj*delayed&lt;br&gt;+ power product&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="265" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Pipeline Register: Post-window -->
        <mxCell id="preg-window" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="8" height="80" as="geometry" />
        </mxCell>

        <!-- Accumulator -->
        <mxCell id="hw-acc" value="&lt;b&gt;ACCUMULATOR&lt;/b&gt;&lt;br&gt;sum_c_re, sum_c_im, sum_p&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;3x ap_fixed&amp;lt;32,12&amp;gt;&lt;br&gt;UNCONDITIONAL update&lt;br&gt;(FP-NOBREAK-CE)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#99e9f2;strokeColor=#0c8599;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="550" y="155" width="150" height="90" as="geometry" />
        </mxCell>

        <!-- Accumulator feedback -->
        <mxCell id="fb-acc" value="feedback" style="endArrow=block;endFill=1;html=1;strokeColor=#868e96;strokeWidth=1;dashed=1;dashPattern=2 4;fontSize=9;fontColor=#868e96;labelBackgroundColor=#FFFFFF;curved=1;" edge="1" source="hw-acc" target="hw-acc" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="530" y="210" />
              <mxPoint x="530" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Pipeline Register: Post-acc -->
        <mxCell id="preg-acc" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;" vertex="1" parent="1">
          <mxGeometry x="720" y="160" width="8" height="80" as="geometry" />
        </mxCell>

        <!-- Truncation -->
        <mxCell id="hw-trunc" value="&lt;b&gt;TRUNC&lt;/b&gt;&lt;br&gt;32b -&gt; 18b&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;accum_t -&gt; trunc_accum_t&lt;br&gt;ap_fixed&amp;lt;18,10&amp;gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="750" y="160" width="120" height="75" as="geometry" />
        </mxCell>

        <!-- Pipeline Register: Post-trunc -->
        <mxCell id="preg-trunc" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;" vertex="1" parent="1">
          <mxGeometry x="890" y="160" width="8" height="80" as="geometry" />
        </mxCell>

        <!-- DSP Square -->
        <mxCell id="hw-square" value="&lt;b&gt;DSP: SQUARE&lt;/b&gt;&lt;br&gt;3 DSP48E1&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;tc_re^2 + tc_im^2 -&gt; corr&lt;br&gt;tp^2 -&gt; pow&lt;br&gt;metric_sq_t (36b)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="920" y="155" width="140" height="90" as="geometry" />
        </mxCell>

        <!-- Pipeline Register: Post-square -->
        <mxCell id="preg-sq" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;" vertex="1" parent="1">
          <mxGeometry x="1080" y="160" width="8" height="80" as="geometry" />
        </mxCell>

        <!-- Metric Register -->
        <mxCell id="hw-metric-reg" value="&lt;b&gt;REG&lt;/b&gt;&lt;br&gt;prev_corr&lt;br&gt;prev_pow&lt;br&gt;&lt;font style='font-size:9px;color:#6b7280;'&gt;metric_sq_t (36b)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e9ecef;strokeColor=#868e96;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1110" y="160" width="100" height="75" as="geometry" />
        </mxCell>

        <!-- Comparator -->
        <mxCell id="hw-cmp" value="&lt;b&gt;&amp;gt; THR&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;'&gt;corr &gt;&lt;br&gt;pow &gt;&gt; 1&lt;/font&gt;" style="shape=rhombus;whiteSpace=wrap;html=1;fillColor=#ffc9c9;strokeColor=#e03131;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="155" width="80" height="80" as="geometry" />
        </mxCell>

        <!-- Control: consecutive counter + detection -->
        <mxCell id="hw-ctrl" value="&lt;b&gt;CTRL&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px;'&gt;consecutive &gt;=&lt;br&gt;SUSTAIN(24)&lt;br&gt;-&gt; detected&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=10;arcSize=12;" vertex="1" parent="1">
          <mxGeometry x="1240" y="270" width="100" height="70" as="geometry" />
        </mxCell>

        <!-- Output: data_out -->
        <mxCell id="io-data-out" value="&lt;b&gt;data_out&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;ALL 26105" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="170" y="385" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Output: startOffset_out -->
        <mxCell id="io-startOffset-out" value="&lt;b&gt;startOffset_out&lt;/b&gt;&lt;br&gt;index_t" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fce7f3;strokeColor=#db2777;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="375" width="100" height="50" as="geometry" />
        </mxCell>

        <!-- Write-through annotation -->
        <mxCell id="anno-writethrough" value="&lt;font style='font-size:9px;color:#059669;'&gt;Write-through: every sample&lt;br&gt;from data_in written to data_out&lt;br&gt;unconditionally inside MAIN_LOOP&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="30" y="390" width="130" height="50" as="geometry" />
        </mxCell>

        <!-- Data flow edges -->
        <mxCell id="edge-in-preg" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="io-data-in" target="preg-in" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-preg-window" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="preg-in" target="hw-window" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Memory access: data_buf -->
        <mxCell id="edge-databuf-window" value="delayed rd" style="endArrow=block;endFill=1;html=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;fontSize=9;fontColor=#4f46e5;labelBackgroundColor=#FFFFFF;edgeStyle=orthogonalEdgeStyle;rounded=1;" edge="1" source="mem-data-buf" target="hw-window" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Memory access: aux products -->
        <mxCell id="edge-aux-window" value="old prod rd/wr" style="endArrow=block;endFill=1;html=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;fontSize=9;fontColor=#4f46e5;labelBackgroundColor=#FFFFFF;edgeStyle=orthogonalEdgeStyle;rounded=1;" edge="1" source="mem-aux" target="dsp-window" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-window-preg2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="hw-window" target="preg-window" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-preg2-acc" value="delta" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="preg-window" target="hw-acc" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-acc-preg3" value="32b" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-acc" target="preg-acc" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-preg3-trunc" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="preg-acc" target="hw-trunc" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-trunc-preg4" value="18b" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-trunc" target="preg-trunc" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-preg4-square" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="preg-trunc" target="hw-square" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-square-preg5" value="36b" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-square" target="preg-sq" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-preg5-metric" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="preg-sq" target="hw-metric-reg" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-metric-cmp" value="36b" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-metric-reg" target="hw-cmp" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Control edge: cmp -> ctrl -->
        <mxCell id="edge-cmp-ctrl" value="detect" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-cmp" target="hw-ctrl" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Control edge: ctrl -> startOffset -->
        <mxCell id="edge-ctrl-offset" value="startOffset" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="hw-ctrl" target="io-startOffset-out" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Write-through edge: input -> data_out -->
        <mxCell id="edge-writethrough" value="write-through (ALL samples)" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="preg-in" target="io-data-out" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="144" y="350" />
              <mxPoint x="144" y="415" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Critical path annotation -->
        <mxCell id="critical-path" value="&lt;font color='#e03131'&gt;&lt;b&gt;Critical Path:&lt;/b&gt; ACC(32b) -&gt; TRUNC(18b) -&gt; SQUARE(3 DSP48) -&gt; REG -&gt; CMP -&gt; CTRL (deferred 3 cycles)&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="355" width="600" height="20" as="geometry" />
        </mxCell>

        <!-- Resource Summary Box -->
        <mxCell id="resource-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f9fafb;strokeColor=#d1d5db;" vertex="1" parent="1">
          <mxGeometry x="340" y="385" width="340" height="120" as="geometry" />
        </mxCell>
        <mxCell id="resource-title" value="&lt;b&gt;Resource Summary (CSYNTH)&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="350" y="390" width="250" height="20" as="geometry" />
        </mxCell>
        <mxCell id="res-dsp" value="DSP48E1: 11 (8 window MUL + 3 metric SQ)" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="355" y="415" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-bram" value="BRAM: data_buf[32] + 3x aux[16] (auto-inferred)" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="355" y="435" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-lut" value="LUT: 528" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="355" y="455" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-ff" value="FF: 688" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="355" y="475" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-ii" value="II: 1 (fully pipelined, no stalls)" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="355" y="488" width="300" height="18" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8f9fa;strokeColor=#495057;" vertex="1" parent="1">
          <mxGeometry x="720" y="385" width="260" height="120" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;Legend&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="730" y="390" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-dsp-box" value="DSP" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="730" y="415" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-dsp-label" value="Compute / DSP48E1" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="790" y="415" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-mem-box" value="MEM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e0e7ff;strokeColor=#4f46e5;dashed=1;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="730" y="440" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-mem-label" value="Memory / Buffer" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="790" y="440" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-acc-box" value="ACC" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#99e9f2;strokeColor=#0c8599;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="730" y="465" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-acc-label" value="Accumulator" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="790" y="465" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-cmp-box" value="CMP" style="shape=rhombus;whiteSpace=wrap;html=1;fillColor=#ffc9c9;strokeColor=#e03131;fontSize=8;" vertex="1" parent="1">
          <mxGeometry x="730" y="488" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-cmp-label" value="Comparator / Threshold" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="790" y="488" width="150" height="20" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
