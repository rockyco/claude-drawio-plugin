<mxfile host="app.diagrams.net" type="device">
  <diagram name="M4 Architecture" id="m4-arch">
    <mxGraphModel dx="1400" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1000">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;module4_fine_cfo_apply - Architecture&lt;/b&gt;&lt;br&gt;Fine CFO Estimation + Correction, FSM + 3-Stage DATAFLOW, circ_buf[16384]" style="text;html=1;align=left;verticalAlign=top;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- Input Ports -->
        <mxCell id="io-data-in" value="&lt;b&gt;data_in&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;~26036 samples" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="280" width="110" height="70" as="geometry" />
        </mxCell>

        <mxCell id="io-fineOffset-in" value="&lt;b&gt;fineOffset_in&lt;/b&gt;&lt;br&gt;index_t&lt;br&gt;(async, ~cycle 7000)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fce7f3;strokeColor=#db2777;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="140" width="130" height="70" as="geometry" />
        </mxCell>

        <!-- Module Box (outer boundary) -->
        <mxCell id="m4-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a5d8ff;strokeColor=#1971c2;fontSize=11;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="200" y="80" width="1060" height="540" as="geometry" />
        </mxCell>
        <mxCell id="m4-label" value="&lt;b&gt;module4_fine_cfo_apply&lt;/b&gt;&lt;br&gt;#pragma HLS DATAFLOW&lt;br&gt;@FSM: YES | CSR=162.7" style="text;html=1;align=left;verticalAlign=top;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="220" y="85" width="320" height="50" as="geometry" />
        </mxCell>

        <!-- EXTRACT Stage -->
        <mxCell id="stage-extract" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="220" y="150" width="290" height="440" as="geometry" />
        </mxCell>
        <mxCell id="stage-extract-label" value="&lt;b&gt;EXTRACT&lt;/b&gt;&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="310" y="155" width="110" height="30" as="geometry" />
        </mxCell>

        <mxCell id="fsm-ctrl" value="&lt;b&gt;FSM Controller&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px'&gt;WAIT_CTRL&lt;br&gt;WAIT_DATA_READY&lt;br&gt;EXTRACT_LLTF&lt;br&gt;PASSTHROUGH&lt;br&gt;DONE&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=10;verticalAlign=top;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="240" y="200" width="130" height="120" as="geometry" />
        </mxCell>

        <mxCell id="circ-buf" value="&lt;b&gt;circ_buf[16384]&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;&lt;font color='#6b7280' style='font-size:9px'&gt;Circular BRAM&lt;br&gt;~26 BRAM18&lt;br&gt;Largest system buffer&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="240" y="360" width="140" height="100" as="geometry" />
        </mxCell>

        <!-- COMPUTE Stage -->
        <mxCell id="stage-compute" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="560" y="150" width="240" height="200" as="geometry" />
        </mxCell>
        <mxCell id="stage-compute-label" value="&lt;b&gt;COMPUTE&lt;/b&gt;&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="630" y="155" width="100" height="30" as="geometry" />
        </mxCell>

        <mxCell id="autocorr" value="&lt;b&gt;Autocorrelation&lt;/b&gt;&lt;br&gt;160 L-LTF samples" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="585" y="200" width="190" height="50" as="geometry" />
        </mxCell>

        <mxCell id="cordic" value="&lt;b&gt;CORDIC atan2&lt;/b&gt;&lt;br&gt;CFO estimation" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="600" y="270" width="160" height="50" as="geometry" />
        </mxCell>

        <!-- APPLY Stage -->
        <mxCell id="stage-apply" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8fafc;strokeColor=#94a3b8;dashed=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="850" y="150" width="380" height="400" as="geometry" />
        </mxCell>
        <mxCell id="stage-apply-label" value="&lt;b&gt;APPLY&lt;/b&gt;&lt;br&gt;II=1" style="text;html=1;align=center;verticalAlign=top;fontSize=11;fontColor=#94a3b8;" vertex="1" parent="1">
          <mxGeometry x="990" y="155" width="100" height="30" as="geometry" />
        </mxCell>

        <mxCell id="nco-lut" value="&lt;b&gt;NCO LUT&lt;/b&gt;&lt;br&gt;sin/cos[1024]&lt;br&gt;&lt;font color='#6b7280' style='font-size:9px'&gt;Quarter-wave&lt;br&gt;1 RAMB18&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="880" y="200" width="120" height="80" as="geometry" />
        </mxCell>

        <mxCell id="phase-acc" value="&lt;b&gt;Phase Accum&lt;/b&gt;&lt;br&gt;phi += delta" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#99e9f2;strokeColor=#0c8599;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="880" y="310" width="120" height="50" as="geometry" />
        </mxCell>

        <mxCell id="cmul" value="&lt;b&gt;Complex MUL&lt;/b&gt;&lt;br&gt;data * exp(-j*phi)&lt;br&gt;&lt;font color='#6b7280' style='font-size:9px'&gt;CFO correction&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dbeafe;strokeColor=#1971c2;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1040" y="250" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Output Ports -->
        <mxCell id="io-data-out" value="&lt;b&gt;data_out&lt;/b&gt;&lt;br&gt;complex_t&lt;br&gt;~26030 samples" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d1fae5;strokeColor=#059669;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1320" y="260" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="io-freq-out" value="&lt;b&gt;fineCfoFreq_out&lt;/b&gt;&lt;br&gt;freq_t" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fce7f3;strokeColor=#db2777;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1320" y="140" width="130" height="60" as="geometry" />
        </mxCell>

        <!-- External I/O edges -->
        <mxCell id="edge-datain-fsm" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="io-data-in" target="fsm-ctrl" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-ctrl-fsm" value="fineOffset" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="io-fineOffset-in" target="fsm-ctrl" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FSM -> circ_buf -->
        <mxCell id="edge-fsm-circ" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;endArrow=block;endFill=1;html=1;" edge="1" source="fsm-ctrl" target="circ-buf" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- EXTRACT -> COMPUTE (lltf_stream) -->
        <mxCell id="edge-extract-compute" value="&lt;b&gt;lltf_stream&lt;/b&gt;&lt;br&gt;160 samples, d=168" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="circ-buf" target="autocorr" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="530" y="410" />
              <mxPoint x="530" y="225" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- EXTRACT -> APPLY (passthrough_stream) -->
        <mxCell id="edge-extract-apply" value="&lt;b&gt;passthrough_stream&lt;/b&gt;&lt;br&gt;~26k samples, d=2048" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="circ-buf" target="cmul" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="310" y="490" />
              <mxPoint x="830" y="490" />
              <mxPoint x="830" y="300" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Autocorr -> CORDIC -->
        <mxCell id="edge-autocorr-cordic" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="autocorr" target="cordic" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- COMPUTE -> APPLY (cfo_stream) -->
        <mxCell id="edge-cfo-nco" value="&lt;b&gt;cfo_stream&lt;/b&gt;&lt;br&gt;freq_t, d=4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="cordic" target="phase-acc" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="680" y="335" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- NCO -> Complex MUL -->
        <mxCell id="edge-nco-cmul" value="sin/cos" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#4f46e5;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#4f46e5;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="nco-lut" target="cmul" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Phase acc -> NCO -->
        <mxCell id="edge-phase-nco" value="index" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="phase-acc" target="nco-lut" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="860" y="335" />
              <mxPoint x="860" y="240" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- APPLY -> outputs -->
        <mxCell id="edge-cmul-out" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#1971c2;strokeWidth=2;endArrow=block;endFill=1;html=1;" edge="1" source="cmul" target="io-data-out" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="edge-cordic-freqout" value="fineCfoFreq" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#e03131;strokeWidth=1;dashed=1;endArrow=block;endFill=1;fontSize=9;fontColor=#e03131;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="cordic" target="io-freq-out" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="680" y="120" />
              <mxPoint x="1385" y="120" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Resource Summary -->
        <mxCell id="resource-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f9fafb;strokeColor=#d1d5db;" vertex="1" parent="1">
          <mxGeometry x="20" y="680" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="resource-title" value="&lt;b&gt;Resource Summary (CSYNTH)&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="30" y="685" width="250" height="20" as="geometry" />
        </mxCell>
        <mxCell id="res-dsp" value="DSP48E1: 18 (autocorr + rotation MUL)" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="35" y="710" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-bram" value="BRAM: 26 (circ_buf[16384] dominates)" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="35" y="730" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-lut" value="LUT: 2001" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="35" y="750" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-ff" value="FF: 1729" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="35" y="770" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="res-pattern" value="Patterns: FP-ASYNC, FP-NCOQUARTER, FP-SEPARATION" style="text;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="35" y="790" width="340" height="18" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f9fafb;strokeColor=#d1d5db;" vertex="1" parent="1">
          <mxGeometry x="440" y="680" width="280" height="140" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;Legend&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="450" y="685" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-data-line" value="" style="endArrow=block;endFill=1;strokeColor=#1971c2;strokeWidth=2;html=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="720" as="sourcePoint" />
            <mxPoint x="500" y="720" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-data-text" value="Data stream" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="510" y="710" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-ctrl-line" value="" style="endArrow=block;endFill=1;strokeColor=#e03131;strokeWidth=1;dashed=1;html=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="745" as="sourcePoint" />
            <mxPoint x="500" y="745" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-ctrl-text" value="Control / async signal" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="510" y="735" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-fsm-box" value="FSM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="450" y="760" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-fsm-text" value="FSM / CORDIC (control)" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="510" y="760" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-mem-box" value="MEM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e0e7ff;strokeColor=#4f46e5;dashed=1;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="450" y="785" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-mem-text" value="BRAM / NCO LUT" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="510" y="785" width="180" height="20" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
