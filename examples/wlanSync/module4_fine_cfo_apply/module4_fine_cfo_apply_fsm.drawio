<mxfile host="app.diagrams.net" type="device">
  <diagram name="M4 FSM State Diagram" id="m4-fsm">
    <mxGraphModel dx="1400" dy="700" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="900">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;module4_fine_cfo_apply - FSM State Diagram (EXTRACT stage)&lt;/b&gt;&lt;br&gt;FP-ASYNC: blocking data read + non-blocking fineOffset poll, circ_buf[16384]" style="text;html=1;align=left;verticalAlign=top;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- Initial marker -->
        <mxCell id="fsm-init" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;aspect=fixed;" vertex="1" parent="1">
          <mxGeometry x="40" y="265" width="20" height="20" as="geometry" />
        </mxCell>

        <!-- State: WAIT_CTRL -->
        <mxCell id="state-wait-ctrl" value="&lt;b&gt;WAIT_CTRL&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;blocking data_in.read()&lt;br&gt;write to circ_buf&lt;br&gt;non-blocking fineOffset poll&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=11;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="100" y="220" width="180" height="110" as="geometry" />
        </mxCell>

        <!-- State: WAIT_DATA_READY -->
        <mxCell id="state-wait-data" value="&lt;b&gt;WAIT_DATA_READY&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;continue filling circ_buf&lt;br&gt;until write_idx &amp;gt;= lltf_end&lt;br&gt;(enough data buffered)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=11;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="370" y="220" width="190" height="110" as="geometry" />
        </mxCell>

        <!-- State: EXTRACT_LLTF -->
        <mxCell id="state-extract" value="&lt;b&gt;EXTRACT_LLTF&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;read 160 L-LTF samples&lt;br&gt;from circ_buf -&gt; lltf_out&lt;br&gt;simultaneous data_in read&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=11;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="650" y="220" width="180" height="110" as="geometry" />
        </mxCell>

        <!-- State: PASSTHROUGH -->
        <mxCell id="state-passthrough" value="&lt;b&gt;PASSTHROUGH&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;replay from circ_buf&lt;br&gt;then stream-through&lt;br&gt;-&gt; passthrough_out&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=11;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="920" y="220" width="180" height="110" as="geometry" />
        </mxCell>

        <!-- State: DONE -->
        <mxCell id="state-done" value="&lt;b&gt;DONE&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;consume remaining&lt;br&gt;data_in (write nothing)&lt;br&gt;if detect=false: skip&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=11;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="1200" y="220" width="170" height="110" as="geometry" />
        </mxCell>

        <!-- Terminal marker -->
        <mxCell id="fsm-terminal" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#000000;aspect=fixed;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="1270" y="380" width="30" height="30" as="geometry" />
        </mxCell>

        <!-- Initial transition -->
        <mxCell id="edge-init" value="reset" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="fsm-init" target="state-wait-ctrl" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Self-loop: WAIT_CTRL -->
        <mxCell id="self-wait-ctrl" value="!fineOffset_in.empty()&lt;br&gt;== false" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d97706;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;fontColor=#d97706;labelBackgroundColor=#FFFFFF;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" source="state-wait-ctrl" target="state-wait-ctrl" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="145" y="170" />
              <mxPoint x="235" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- WAIT_CTRL -> WAIT_DATA_READY -->
        <mxCell id="edge-wc-wd" value="ctrl_received&lt;br&gt;&amp;amp;&amp;amp; write_idx &amp;lt; lltf_end" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-wait-ctrl" target="state-wait-data" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Self-loop: WAIT_DATA_READY -->
        <mxCell id="self-wait-data" value="write_idx &lt;&lt;br&gt;lltf_end" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d97706;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;fontColor=#d97706;labelBackgroundColor=#FFFFFF;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" source="state-wait-data" target="state-wait-data" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="418" y="170" />
              <mxPoint x="513" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- WAIT_DATA_READY -> EXTRACT_LLTF -->
        <mxCell id="edge-wd-ex" value="write_idx &gt;= lltf_end" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-wait-data" target="state-extract" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- WAIT_CTRL -> EXTRACT (shortcut: ctrl arrives with enough data) -->
        <mxCell id="edge-wc-ex" value="ctrl_received&lt;br&gt;&amp;amp;&amp;amp; write_idx &gt;= lltf_end" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-wait-ctrl" target="state-extract" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="190" y="440" />
              <mxPoint x="740" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Self-loop: EXTRACT_LLTF -->
        <mxCell id="self-extract" value="i &lt;&lt;br&gt;EXTRACT_LEN" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d97706;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;fontColor=#d97706;labelBackgroundColor=#FFFFFF;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" source="state-extract" target="state-extract" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="695" y="170" />
              <mxPoint x="785" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- EXTRACT_LLTF -> PASSTHROUGH -->
        <mxCell id="edge-ex-pass" value="i &gt;= EXTRACT_LEN (160)" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-extract" target="state-passthrough" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Self-loop: PASSTHROUGH -->
        <mxCell id="self-pass" value="replay/stream&lt;br&gt;not complete" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d97706;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;fontColor=#d97706;labelBackgroundColor=#FFFFFF;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" source="state-passthrough" target="state-passthrough" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="965" y="170" />
              <mxPoint x="1055" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- PASSTHROUGH -> DONE -->
        <mxCell id="edge-pass-done" value="all passthrough written" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-passthrough" target="state-done" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Self-loop: DONE -->
        <mxCell id="self-done" value="n &lt;&lt;br&gt;num_samples" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d97706;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;fontColor=#d97706;labelBackgroundColor=#FFFFFF;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" source="state-done" target="state-done" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1243" y="170" />
              <mxPoint x="1328" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- DONE -> terminal -->
        <mxCell id="edge-done-term" value="n == num_samples" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#495057;strokeWidth=1;endArrow=block;endFill=1;fontSize=9;labelBackgroundColor=#FFFFFF;html=1;" edge="1" source="state-done" target="fsm-terminal" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Circular buffer annotation -->
        <mxCell id="circ-buf-note" value="&lt;b&gt;circ_buf[16384]&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:9px'&gt;Shared across all states&lt;br&gt;WAIT_CTRL: write data_in -&gt; buf&lt;br&gt;WAIT_DATA_READY: continue writing&lt;br&gt;EXTRACT_LLTF: read 160 from buf&lt;br&gt;PASSTHROUGH: replay + stream-through&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;fillColor=#e0e7ff;strokeColor=#4f46e5;fontSize=10;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="420" y="480" width="220" height="120" as="geometry" />
        </mxCell>

        <!-- Data path annotation -->
        <mxCell id="data-path-note" value="&lt;font style='font-size:10px'&gt;&lt;b&gt;Data Flow:&lt;/b&gt; data_in -&gt; circ_buf -&gt; lltf_out (160 samples) + passthrough_out (~26k samples)&lt;br&gt;&lt;b&gt;Ctrl:&lt;/b&gt; fineOffset_in (async, ~cycle 7000 from M3) -&gt; triggers EXTRACT at correct offset&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="20" y="490" width="380" height="50" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f9fafb;strokeColor=#d1d5db;" vertex="1" parent="1">
          <mxGeometry x="20" y="610" width="380" height="110" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;Legend&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="30" y="615" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-state-box" value="STATE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fef3c7;strokeColor=#d97706;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="30" y="640" width="60" height="22" as="geometry" />
        </mxCell>
        <mxCell id="legend-state-text" value="FSM state (enum + switch)" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="100" y="642" width="170" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-self-text" value="Self-loop (guard condition stays in state)" style="text;html=1;align=left;fontSize=9;fontColor=#d97706;" vertex="1" parent="1">
          <mxGeometry x="100" y="667" width="250" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-trans-line" value="" style="endArrow=block;endFill=1;strokeColor=#495057;strokeWidth=1;html=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="30" y="700" as="sourcePoint" />
            <mxPoint x="80" y="700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-trans-text" value="Forward transition" style="text;html=1;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="100" y="692" width="170" height="20" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
